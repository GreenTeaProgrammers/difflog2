# プロジェクト健全性診断レポート (2025/06/28)

## 1. 概要

フロントエンド (`frontend-next`) とバックエンド (`backend`) のコードベース全体を対象に、ドキュメントの記述に留まらない詳細なコードレビューを実施しました。その結果、アプリケーションの安定性、保守性、拡張性に影響を及ぼす可能性のある、複数の構造的な問題が明らかになりました。

このレポートは、発見された問題点を整理し、その改善策を提案するものです。

---

## 2. バックエンド (`backend`) の問題点と改善案

バックエンドは現在ビルド可能で動作しますが、コード品質とアーキテクチャに深刻な問題を抱えています。

### 問題点 1: 密結合なアーキテクチャとテストの困難性

*   **現象:** データベース接続 (`gorm.DB`) がグローバル変数として管理されており、ほとんどのコントローラーがこのグローバルな状態に暗黙的に依存しています。
*   **影響:**
    *   **テスト不能:** コンポーネントを個別にテストすることができず、常に実際のデータベースが必要になります。これにより、ユニットテストの導入が極めて困難です。
    *   **保守性の低下:** コンポーネント間の依存関係が不透明になり、コードの変更が予期せぬ副作用を生むリスクが高まります。
    *   **設計の不統一:** `DetectionController` のみ異なる設計思想で実装されており、一貫性がありません。

### 問題点 2: 潜在的なバグ (不正確なエラーハンドリング)

*   **現象:** ユーザー登録処理 (`auth_controller.go`) において、ユーザー名が重複した場合のエラー判定ロジックが間違っています。
*   **影響:** 本来であれば「ユーザー名が既に使用されています」という明確なエラーを返すべきところ、意図しないサーバーエラーが返ってしまい、ユーザー体験を損ないます。

### **改善案**

1.  **依存性注入 (DI) の導入:**
    *   `uber-go/dig` のようなDIコンテナを導入するか、手動で依存性を注入することにより、コンポーネントをグローバルな状態から切り離します。
2.  **リポジトリパターンの採用:**
    *   データベース操作をカプセル化するリポジトリ層を導入し、コントローラーから直接GORMのコードを呼び出さないようにします。
3.  **エラーハンドリングの修正:**
    *   データベースの制約違反エラーを正しくハンドリングし、クライアントに適切なエラー情報を返却するように修正します。

---

## 3. フロントエンド (`frontend-next`) の問題点と改善案

フロントエンドはNext.jsへのリファクタリングが進行中ですが、その過程でアーキテクチャ上の大きな問題が発生しています。

### 問題点 1: 認証実装の混乱 (最重要課題)

*   **現象:** **NextAuth.jsによる認証**と、**手動のServer Actionsによる認証**という、2つの異なる認証フローが完全に混在しています。
*   **影響:**
    *   **信頼性の欠如:** 認証ロジックが二重に存在するため、セッション管理に不整合が生じ、予期せぬバグの温床となります。
    *   **保守性の著しい低下:** 認証の全体像を把握することが極めて困難であり、将来の機能追加やデバッグを妨げます。

### 問題点 2: API連携の不備

*   **現象:** バックエンドのログインAPIが返すユーザー情報と、NextAuth.jsがセッションに格納するために期待するユーザー情報の間に食い違いがあります（`id` や `email` が不足）。
*   **影響:** 認証自体は成功しても、フロントエンド側でユーザーIDなどの重要な情報を利用できず、アプリケーションが正常に機能しない可能性があります。

### **改善案**

1.  **認証フローの統一:**
    *   認証の主軸を **NextAuth.jsに一本化**します。
    *   既存のServer Actions (`login`, `register`, `logout`) は、NextAuth.jsが提供する `signIn`, `signOut` 関数や、バックエンドAPIを呼び出すヘルパー関数に置き換えます。フォームからの呼び出しもこれらに統一します。
2.  **APIレスポンスの修正:**
    *   バックエンドの `/login` エンドポイントが、レスポンスに `id` と `email` を含めるように修正します。

---

## 4. 全体的な問題

### 問題点: ドキュメントの陳腐化

*   **現象:** `report.md` や `refactoring_plan.md` などのドキュメントが現状のコードと大きく乖離しており、全くメンテナンスされていません。
*   **影響:** ドキュメントが信頼性を失い、プロジェクトの引き継ぎや新規開発者の参加を困難にします。

### **改善案**

*   今回の調査結果を基に、すべての関連ドキュメントを更新します。
*   今後、大きな変更を加える際には、関連ドキュメントの更新も必須タスクとすることをチームで徹底します。

---

## 5. 具体的な改善タスク (TODO)

上記の改善案を、具体的なタスクとして以下にまとめます。詳細は `refactoring_plan.md` を参照してください。

### Phase 1: バックエンドのアーキテクチャ改善
- **[ ] TODO:** ログインAPIのレスポンス修正 (`id`, `email` を追加)
- **[ ] TODO:** ユーザー登録時のエラーハンドリング修正
- **[ ] TODO:** 依存性注入 (DI) の導入
- **[ ] TODO:** リポジトリパターンの導入
- **[ ] TODO:** 設定管理の統一

### Phase 2: フロントエンドの認証フロー統一
- **[ ] TODO:** Server Actions の削除または置換
- **[ ] TODO:** フォームの処理をNextAuth.jsに移行
- **[ ] TODO:** 不要なCookie操作の削除

### Phase 3: ドキュメントの更新とクリーンアップ
- **[ ] TODO:** `report.md` の進捗反映
- **[ ] TODO:** 旧 `frontend` ディレクトリの削除
- **[ ] TODO:** `compose.yml` の更新
