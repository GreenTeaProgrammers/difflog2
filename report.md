# 作業報告書

## 1. 目的

バックエンドアーキテクチャの簡素化を目的とし、`backend` (Go) と `mlService` (Python) に分離していたサービスを、単一のモノリシックなバックエンドに統合する。

## 2. 実施内容

### 2.1. アーキテクチャの分析と計画

- `compose.yml`、`backend`、`mlService` のコードを分析し、現状のアーキテクチャを把握した。
- 問題点として、不要なマイクロサービス化による複雑性の増大と運用オーバーヘッドを特定した。
- 解決策として、`mlService` の機能を `backend` に統合する方針を立て、具体的なタスクを計画した。
- これらの分析結果と計画を `backend_problems.md` にまとめた。

### 2.2. モデルの変換

- `mlService` で使用されていたPyTorch形式のYOLOモデル (`.pt`) を、Go言語からでも利用可能なONNX形式 (`.onnx`) に変換した。
- 変換用のPythonスクリプト (`export_onnx.py`) を作成し、実行した。

### 2.3. Goバックエンドへの統合

- Go言語でONNXモデルを扱うためのライブラリ (`github.com/owulveryck/onnx-go`) を `backend` プロジェクトに導入した。
- 変換済みのONNXモデルファイル (`yolomodel.onnx`, `book.onnx`) を `backend/models/onnx/` ディレクトリに配置した。
- 画像を受け取り、ONNXモデルで推論を行うためのAPIエンドポイント `/detect` を実装した。
    - `controllers/detection_controller.go`: 推論処理の骨格を実装。
    - `routes/detection_route.go`: APIルーティングを定義。
    - `main.go`: 新しいルートを登録。

### 2.4. クリーンアップ

- 機能統合が完了したため、不要となった `mlService` ディレクトリをプロジェクトから削除した。

## 3. 現在の状況

- バックエンドは単一のGoアプリケーションに統合された。
- `/detect` エンドポイントは存在するが、推論処理の主要な部分である **画像のプリプロセッシング** と **モデル出力のポストプロセッシング** が未実装の状態。
- このため、APIはまだ完全には機能しない。

## 4. 今後の課題

- `backend/controllers/detection_controller.go` 内に、以下の処理を実装する必要がある。
    1.  **画像のプリプロセッシング**: 入力画像をモデルが要求する形式（例: 640x640のサイズ、ピクセル値の正規化、NCHW形式への変換）に変換するロジック。
    2.  **モデル出力のポストプロセッシング**: モデルから出力されたテンソルを解析し、物体のバウンディングボックス、クラスラベル、信頼度スコアといった具体的な情報に変換するロジック。
